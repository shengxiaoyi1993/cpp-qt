# design of dircam control


- 交互层次
```
- 用户层 输入点和位移和操作结果 知道连接状态
- 转接层 对输入的数据进行转换 对通道自身的状态进行监控和通知
- 传输层 win：使用Qt QSerialPort进行通讯 发送和接受
```

## 交互流程 progress

- 用户操作

```
- 设置参数
- 建立连接
- 验证连接状态
- 发送操作/数据
```

- 一次交互过程

```
- server-service获取操作/数据
- 在设备代理中寻找到对应的设备
- 调用设备的接口传入数据
- 验证数据的正确性
- 根据操作类型调用相应接口
- 根据返回的数据，验证操作的正确性后
- 返回结果  
```


## 封装  wrapper/interface

- 构造
  - 若参数齐全，则尝试建立连接
- 设置参数
  - 在未连接下进行，不尝试连接
- 连接
  - 若参数齐全，则尝试建立连接
- 连接状态
  - 随连接状态即时该变换，包含侦测设备连接状态的机制
- 操作设备  ：参数不合理则输出操作失败
  - 先进行数值合理性验证，然后进行操作
- 解除连接
  - 需要在连接状态下进行，返回是否操作成功 不反映设备的连接状态
<!-- - 测试连接 -->

- 析构
  - 若连接建立则解除连接
- 设备内部需要建立设备内部的调整数值，防止客户对设备的操作出错问题：保存24个点的状态，针对某个点的操作是否选择了图外的点
- 对于用户操作的友好程度：客户端的操作界面是否使客户误解
- 注意：实现过程对于重连过程的考虑





## 交互实现 complement
- 转接器实现： 4种数据结构
```
- 写数据发送
  - 5+2+4 同步字+操作类型+地址+数据
  - 后6位高低位反转
  - 后7字节计算CRC


- 写数据返回
  - 1
  - 与CRC比较
- 读数据发送
  - 3+2+2 同步字+操作类型+地址
  - 后两个字节反转
- 读数据返回
  - 1+4 crc+数据
  - 后两个字节反转
  - 后3个字节计算CRC
```

- 数据位数转换
  - 寄存器的值为10位有符号数，传入的数据为16，转换成字符串时注意符号的变换


## 待做事项
- 连接测试
  - 创建一个临时的对象，对连接状态进行测试然后释放该对象
- 设备连接状态的确定
  - 有两种状态 UART建立连接/UART可进行数据传输

- 设备写入操作花费时间
  - 现在花费的时间较长，需要在查看写入和读取的各个步骤
